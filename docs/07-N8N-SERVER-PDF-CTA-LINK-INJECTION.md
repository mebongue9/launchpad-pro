# 07 - n8n Server: PDF CTA Link Injection

**Date:** February 10, 2026
**Status:** Production
**Purpose:** Inject a clickable hyperlink onto the CTA image on the last page of branded PDFs generated by the "Etsy Empire Engine - Word Branding" n8n workflow.

---

## Problem

CloudConvert strips image hyperlinks when converting DOCX to PDF. The branded `.docx` has a clickable CTA image on the last page, but after conversion the link is gone. This post-processing step adds it back.

---

## Server Access

| Field | Value |
|-------|-------|
| Host | `95.217.101.30` |
| SSH Port | `2222` |
| User | `root` |
| n8n URL | `https://n8n.martinebongue.com` |

```bash
ssh -p 2222 root@95.217.101.30
```

---

## Container Configuration

### Docker Run Command (for full rebuild)

```bash
docker run -d \
  --name n8n \
  --network new-attachable-network \
  --restart unless-stopped \
  -v n8n_n8n-data:/home/node/.n8n \
  -v /home/user/scripts:/home/user/scripts \
  -e N8N_SECURE_COOKIE=false \
  -e 'WEBHOOK_URL=https://n8n.martinebongue.com/' \
  -e 'NODE_FUNCTION_ALLOW_BUILTIN=fs,crypto,child_process' \
  -e 'NODE_FUNCTION_ALLOW_EXTERNAL=pdf-lib' \
  -l 'traefik.enable=true' \
  -l 'traefik.http.routers.n8n.entrypoints=websecure' \
  -l 'traefik.http.routers.n8n.rule=Host(`n8n.martinebongue.com`)' \
  -l 'traefik.http.routers.n8n.tls.certresolver=myresolver' \
  -l 'traefik.http.services.n8n.loadbalancer.server.port=5678' \
  n8n-with-pdflib
```

### Key Details

| Component | Value |
|-----------|-------|
| Base image | `docker.n8n.io/n8nio/n8n` (v2.6.4) |
| Committed image (with pdf-lib) | `n8n-with-pdflib` |
| Network | `new-attachable-network` (Traefik-routed) |
| Data volume | `n8n_n8n-data` mounted at `/home/node/.n8n` |
| Scripts volume | `/home/user/scripts` mounted at `/home/user/scripts` |
| Restart policy | `unless-stopped` |
| Node.js | v22.22.0 (Alpine 3.22) |
| Package manager | pnpm 10.29.2 |

### Environment Variables

| Variable | Value | Purpose |
|----------|-------|---------|
| `NODE_FUNCTION_ALLOW_EXTERNAL` | `pdf-lib` | Allows Code nodes to `require('pdf-lib')` |
| `NODE_FUNCTION_ALLOW_BUILTIN` | `fs,crypto,child_process` | Allows built-in Node modules in Code nodes |
| `N8N_SECURE_COOKIE` | `false` | Required for HTTP (Traefik handles TLS) |
| `WEBHOOK_URL` | `https://n8n.martinebongue.com/` | Public webhook base URL |

### Traefik Labels

| Label | Value |
|-------|-------|
| `traefik.enable` | `true` |
| `traefik.http.routers.n8n.entrypoints` | `websecure` |
| `traefik.http.routers.n8n.rule` | `Host(\`n8n.martinebongue.com\`)` |
| `traefik.http.routers.n8n.tls.certresolver` | `myresolver` |
| `traefik.http.services.n8n.loadbalancer.server.port` | `5678` |

---

## pdf-lib Installation

### Why the install location matters

n8n 2.6.4 runs Code nodes inside `@n8n/task-runner`, which has its own module resolution. Installing pdf-lib globally or in the n8n root does NOT work. It must be inside the task-runner's own `node_modules/`.

### Exact installation path

```
/usr/local/lib/node_modules/n8n/node_modules/.pnpm/@n8n+task-runner@file+packages+@n8n+task-runner_@opentelemetry+api@1.9.0_@opentelemetry_eb51b38615a039445701c88b088f88d0/node_modules/@n8n/task-runner/node_modules/pdf-lib/
```

### Installed packages (in that directory)

- `pdf-lib` - Main PDF manipulation library
- `@pdf-lib/standard-fonts` - Dependency
- `@pdf-lib/upng` - Dependency
- `pako` - Dependency (compression)

### Install procedure (if rebuilding from scratch)

You cannot run `npm install` directly in the task-runner directory because its `package.json` uses pnpm's `workspace:*` protocol. Instead:

```bash
# 1. Exec into the container as root
docker exec -u root -it n8n sh

# 2. Find the task-runner directory
TASK_RUNNER_DIR=$(dirname $(dirname $(find /usr/local/lib/node_modules/n8n -path "*task-runner/dist/js-task-runner/require-resolver.js" 2>/dev/null | head -1)))
echo "Task runner dir: $TASK_RUNNER_DIR"

# 3. Install pdf-lib in a temp directory (avoids workspace: protocol error)
mkdir -p /tmp/pdflib-install
cd /tmp/pdflib-install
npm init -y
npm install pdf-lib

# 4. Copy pdf-lib and ALL its dependencies to the task-runner's node_modules
mkdir -p "$TASK_RUNNER_DIR/node_modules"
cp -r /tmp/pdflib-install/node_modules/pdf-lib "$TASK_RUNNER_DIR/node_modules/"
cp -r /tmp/pdflib-install/node_modules/@pdf-lib "$TASK_RUNNER_DIR/node_modules/"
cp -r /tmp/pdflib-install/node_modules/pako "$TASK_RUNNER_DIR/node_modules/"

# 5. Verify
cd "$TASK_RUNNER_DIR"
node -e "require('pdf-lib'); console.log('pdf-lib OK from task-runner dir')"

# 6. Exit container
exit

# 7. Commit the container state (so it survives image-based restarts)
docker commit n8n n8n-with-pdflib

# 8. Restart
docker restart n8n
```

### Verification commands

```bash
# Verify pdf-lib is importable from task-runner context
docker exec n8n sh -c 'cd /usr/local/lib/node_modules/n8n/node_modules/.pnpm/@n8n+task-runner@file+packages+@n8n+task-runner_@opentelemetry+api@1.9.0_@opentelemetry_eb51b38615a039445701c88b088f88d0/node_modules/@n8n/task-runner && node -e "require(\"pdf-lib\"); console.log(\"pdf-lib OK\")"'

# Verify env var
docker exec n8n printenv | grep NODE_FUNCTION_ALLOW_EXTERNAL

# Verify n8n is running
docker ps --format '{{.Names}} {{.Status}}' | grep n8n
```

---

## n8n Workflow: "Inject CTA Link" Code Node

### Workflow position

```
... -> Download PDF1 -> [Inject CTA Link] -> Cleanup1 -> Return PDF1
```

### Node configuration

- **Type:** Code
- **Name:** Inject CTA Link
- **Language:** JavaScript

### Code

```javascript
const { PDFDocument, rgb } = require('pdf-lib');

// Get the PDF binary from the previous node
const pdfBinary = await this.helpers.getBinaryDataBuffer(0, 'data');

// Get the CTA link URL from the webhook payload
const ctaLink = $('Webhook').first().json.body.promo_image_link;

if (!ctaLink) {
  // No promo link provided - pass PDF through unchanged
  return [{
    json: { success: true, linkInjected: false },
    binary: $input.first().binary
  }];
}

// Load the PDF
const pdfDoc = await PDFDocument.load(pdfBinary);

// Get the last page
const pageCount = pdfDoc.getPageCount();
const lastPage = pdfDoc.getPage(pageCount - 1);
const { width, height } = lastPage.getSize();

// Define the clickable area covering the CTA image
// The CTA image is typically on the bottom portion of the last page
// We cover a generous area: full width, bottom 60% of the page
const linkX = 0;
const linkY = 0;
const linkWidth = width;
const linkHeight = height * 0.6;

// Create the link annotation using pdf-lib's lower-level API
const context = pdfDoc.context;

// Wrap the action properly
const actionDict = context.obj({
  Type: 'Action',
  S: 'URI',
  URI: ctaLink,
});

const annotDict = context.obj({
  Type: 'Annot',
  Subtype: 'Link',
  Rect: [linkX, linkY, linkX + linkWidth, linkY + linkHeight],
  Border: [0, 0, 0],
  A: actionDict,
});

const annotRef = context.register(annotDict);

// Get or create the Annots array on the last page
const existingAnnots = lastPage.node.lookup(
  require('pdf-lib').PDFName.of('Annots')
);

if (existingAnnots) {
  existingAnnots.push(annotRef);
} else {
  const annotsArray = context.obj([annotRef]);
  lastPage.node.set(
    require('pdf-lib').PDFName.of('Annots'),
    annotsArray
  );
}

// Save the modified PDF
const modifiedPdfBytes = await pdfDoc.save();
const modifiedBuffer = Buffer.from(modifiedPdfBytes);

// Create binary output
const binaryData = await this.helpers.prepareBinaryData(
  modifiedBuffer,
  'branded_document.pdf',
  'application/pdf'
);

return [{
  json: {
    success: true,
    linkInjected: true,
    ctaLink: ctaLink,
    pageCount: pageCount,
    linkArea: { x: linkX, y: linkY, width: linkWidth, height: linkHeight }
  },
  binary: {
    data: binaryData
  }
}];
```

### How it works

1. Reads the PDF binary from the previous "Download PDF1" node
2. Reads `promo_image_link` from the webhook payload
3. If no link provided, passes the PDF through unchanged
4. Otherwise, loads the PDF with pdf-lib
5. Gets the last page dimensions
6. Creates a PDF link annotation (invisible rectangle) covering the bottom 60% of the last page
7. The annotation is a URI action pointing to the `promo_image_link`
8. Saves the modified PDF and passes it to the next node

### Adjusting the link area

PDF coordinates start from bottom-left (0,0). Current settings:
- `linkX = 0` (left edge)
- `linkY = 0` (bottom edge)
- `linkWidth = width` (full page width)
- `linkHeight = height * 0.6` (bottom 60% of page)

To change:
- Bottom third only: `linkHeight = height * 0.33`
- Centered image: `linkX = width * 0.1; linkWidth = width * 0.8`
- Top half: `linkY = height * 0.5; linkHeight = height * 0.5`

---

## Troubleshooting

### "Cannot find module 'pdf-lib'"
The package is not in the task-runner's node_modules. Follow the install procedure above. Make sure you install in the task-runner directory, NOT globally.

### "External module is not allowed"
`NODE_FUNCTION_ALLOW_EXTERNAL=pdf-lib` is not set. Recreate the container with this env var (see Docker Run Command above).

### "promo_image_link" not found
The webhook payload field name may differ. Check the actual payload and update the line:
```javascript
const ctaLink = $('Webhook').first().json.body.promo_image_link;
```

### Container restarted and pdf-lib is gone
If the container was recreated from the base image instead of `n8n-with-pdflib`, pdf-lib will be lost. Either:
1. Use the committed `n8n-with-pdflib` image, OR
2. Re-run the install procedure above

### n8n updated and task-runner path changed
After an n8n version upgrade, the pnpm hash in the task-runner path will change. Re-run:
```bash
find /usr/local/lib/node_modules/n8n -path "*task-runner/dist/js-task-runner/require-resolver.js"
```
Then reinstall pdf-lib at the new path.

---

## Full Rebuild Checklist

If starting from scratch:

1. [ ] Pull base image: `docker pull docker.n8n.io/n8nio/n8n`
2. [ ] Create network: `docker network create new-attachable-network` (if not exists)
3. [ ] Create volume: `docker volume create n8n_n8n-data` (if not exists)
4. [ ] Run container with the Docker Run Command above (using base image first)
5. [ ] Install pdf-lib in the task-runner directory (follow install procedure)
6. [ ] Commit: `docker commit n8n n8n-with-pdflib`
7. [ ] Stop/remove container, re-run with `n8n-with-pdflib` image
8. [ ] Verify pdf-lib, env var, and n8n accessibility
9. [ ] Add the "Inject CTA Link" Code node to the workflow in n8n UI
10. [ ] Test with a webhook call that includes `promo_image_link`
